generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Incident {
  id           Int            @id @default(autoincrement())
  errorLog     String         @map("error_log")
  status       String         @default("open")
  hostname     String         @default("unknown")
  repoUrl      String?        @map("repo_url")
  context      String?
  prCreated    Boolean        @default(false) @map("pr_created")
  prUrl        String?        @map("pr_url")
  createdAt    DateTime       @default(now()) @map("created_at")
  agentSession AgentSession?
  agentLogs    AgentLog[]

  @@map("incidents")
}

model AgentSession {
  id         Int        @id @default(autoincrement())
  incidentId Int        @unique @map("incident_id")
  status     String     @default("pending")
  workDir    String?    @map("work_dir")
  branch     String?
  startedAt  DateTime?  @map("started_at")
  endedAt    DateTime?  @map("ended_at")
  error      String?
  incident   Incident   @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  toolCalls  ToolCall[]

  @@map("agent_sessions")
}

model ToolCall {
  id        Int          @id @default(autoincrement())
  sessionId Int          @map("session_id")
  name      String
  args      String
  result    String?
  error     String?
  createdAt DateTime     @default(now()) @map("created_at")
  session   AgentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("tool_calls")
}

model AgentLog {
  id         Int      @id @default(autoincrement())
  incidentId Int      @map("incident_id")
  type       String
  content    String
  createdAt  DateTime @default(now()) @map("created_at")
  incident   Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@map("agent_logs")
}
